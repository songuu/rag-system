# 意图蒸馏系统完整指南

## 一、什么是意图蒸馏？

**意图蒸馏（Intent Distillation）**是一个智能查询优化系统，它通过以下步骤将用户的原始查询转化为更精准、更有效的检索查询：

```
用户原始查询
    ↓
领域识别 (使用领域向量质心)
    ↓
意图分析 (使用 LLM 深度理解)
    ↓
查询优化 (生成扩展查询)
    ↓
置信度评估
    ↓
优化建议 + 改写查询
```

### 核心价值

1. **提升检索准确度**: 将模糊查询转化为精准查询
2. **扩展检索范围**: 生成多角度的相关查询
3. **领域聚焦**: 识别查询所属领域，添加领域特定术语
4. **意图明确化**: 深度理解用户真实需求

## 二、系统架构

### 2.1 技术栈

| 组件 | 技术 | 作用 |
|------|------|------|
| 领域识别 | 领域向量质心 + 余弦相似度 | 识别查询所属领域 |
| 意图分析 | llama3.1 LLM | 深度理解查询意图 |
| 向量化 | nomic-embed-text | 将文本转为 768 维向量 |
| 查询改写 | LLM + 规则引擎 | 生成优化查询 |
| 置信度评估 | 多因子加权评分 | 评估分析质量 |

### 2.2 数据流

```
┌─────────────────┐
│   用户查询      │
│ "如何优化数据库" │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 步骤 1: 领域分布分析                │
│ - 向量化查询                        │
│ - 计算与各领域质心的余弦相似度      │
│ - 识别最匹配领域: 技术 (85%)        │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 步骤 2: LLM 意图分析               │
│ - 输入: 查询 + 领域上下文           │
│ - 输出:                             │
│   * 核心意图                        │
│   * 意图类型 (问题解决)             │
│   * 扩展查询 (3个不同角度)          │
│   * 关键词提取                      │
│   * 分析推理                        │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 步骤 3: 查询改写                   │
│ - 基于领域的改写                    │
│ - 基于意图的改写                    │
│ - 关键词增强                        │
│ - 去重生成最终查询列表              │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 步骤 4: 置信度评估                 │
│ - 领域匹配度 (30%)                 │
│ - LLM 分析置信度 (40%)             │
│ - 关键词丰富度 (20%)               │
│ - 查询扩展质量 (10%)               │
│ → 综合置信度评分                   │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│ 输出结果                            │
│ - 识别的意图                        │
│ - 优化的查询列表                    │
│ - 置信度分析                        │
│ - 优化建议                          │
└─────────────────────────────────────┘
```

## 三、完整工作流程

### 3.1 领域分布分析

**目的**: 识别查询所属的领域（技术、商业、日常、情感等）

**实现**:
```typescript
// 1. 向量化查询
const queryEmbedding = await getEmbedding(query);

// 2. 归一化
const norm = sqrt(sum(queryEmbedding^2));
const normalizedQuery = queryEmbedding / norm;

// 3. 计算与各领域质心的相似度
for (domain in centroids) {
  similarity = cosineSimilarity(normalizedQuery, domain.centroid);
}

// 4. 排序并返回
domains.sort((a, b) => b.similarity - a.similarity);
```

**输出示例**:
```json
{
  "topDomain": {
    "name": "技术",
    "similarity": 0.8542,
    "icon": "💻"
  },
  "allDomains": [
    { "name": "技术", "similarity": 0.8542 },
    { "name": "学术", "similarity": 0.6218 },
    { "name": "商业", "similarity": 0.4875 }
  ]
}
```

### 3.2 LLM 意图分析

**目的**: 深度理解用户的真实意图和需求

**Prompt 设计**:
```
你是一个专业的查询意图分析专家。请深入分析以下用户查询的意图。

用户查询: "如何优化数据库性能？"

领域分布分析:
- 主要领域: 技术(85.4%), 学术(62.2%), 商业(48.8%)
- 最匹配领域: 技术 (85.4%)

请按照以下 JSON 格式输出分析结果:
{
  "intent": "用简洁的一句话描述用户的核心意图",
  "intentType": "选择: 信息查询/问题解决/学习探索/操作指导/对比分析/创意生成",
  "confidence": 0.0-1.0,
  "expandedQueries": [
    "扩展查询1: 从不同角度重新表述",
    "扩展查询2: 添加相关细节",
    "扩展查询3: 深入特定方面"
  ],
  "keywords": ["关键词1", "关键词2", ...],
  "reasoning": "详细解释分析思路"
}
```

**输出示例**:
```json
{
  "intent": "寻找提升数据库查询性能的具体方法和优化策略",
  "intentType": "问题解决",
  "confidence": 0.85,
  "expandedQueries": [
    "数据库索引优化和查询性能提升的最佳实践",
    "如何通过SQL优化和数据库配置提高查询速度",
    "数据库性能瓶颈分析和调优方法"
  ],
  "keywords": [
    "数据库", "性能", "优化", "查询", "索引",
    "SQL", "调优", "瓶颈", "配置"
  ],
  "reasoning": "用户面临数据库性能问题，需要实用的优化方案。查询属于技术领域，意图类型是问题解决。从三个角度扩展：1)索引优化 2)SQL和配置 3)瓶颈分析。"
}
```

### 3.3 查询改写

**目的**: 基于意图分析生成优化的查询变体

**改写策略**:

1. **领域聚焦改写**
   - 检测: 领域相似度 > 0.7
   - 操作: 添加领域特定术语
   - 示例: "数据库性能" → "数据库性能优化 索引 查询计划"

2. **意图导向改写**
   - 问题解决 → "如何解决..."、"...的方法"
   - 学习探索 → "...的原理"、"深入理解..."
   - 操作指导 → "...步骤"、"...教程"

3. **关键词增强**
   - 将提取的关键词添加到查询中
   - 示例: "优化数据库 (关键词: 索引, SQL, 调优)"

**输出示例**:
```json
{
  "original": "如何优化数据库性能？",
  "rewritten": [
    "数据库索引优化和查询性能提升的最佳实践",
    "如何通过SQL优化和数据库配置提高查询速度",
    "数据库性能瓶颈分析和调优方法",
    "如何优化数据库性能？(关键词: 索引, SQL, 调优, 瓶颈, 配置)"
  ],
  "improvements": [
    {
      "type": "领域聚焦",
      "description": "查询与技术领域高度相关，已添加领域特定术语"
    },
    {
      "type": "解决方案导向",
      "description": "将查询重构为明确的解决方案请求"
    },
    {
      "type": "关键词增强",
      "description": "添加了 9 个识别的关键词"
    }
  ]
}
```

### 3.4 置信度评估

**目的**: 评估意图分析的质量和可靠性

**评分模型**:
```typescript
置信度 = Σ (因子得分 × 权重)

因子1: 领域匹配度 (30%)
  = 最匹配领域的相似度
  
因子2: LLM 分析置信度 (40%)
  = LLM 返回的 confidence 值
  
因子3: 关键词丰富度 (20%)
  = min(1.0, 关键词数量 / 10)
  
因子4: 查询扩展质量 (10%)
  = min(1.0, 扩展查询数量 / 3)
```

**置信度等级**:
- **High (≥ 0.8)**: 意图分析高度可靠，建议直接使用优化查询
- **Medium (0.6-0.8)**: 意图分析较可靠，可参考优化建议
- **Low (< 0.6)**: 意图分析不确定，建议重新表述查询

**输出示例**:
```json
{
  "overall": 0.83,
  "level": "high",
  "factors": [
    { "factor": "领域匹配度", "score": 0.8542, "weight": 0.3 },
    { "factor": "LLM 分析置信度", "score": 0.85, "weight": 0.4 },
    { "factor": "关键词丰富度", "score": 0.9, "weight": 0.2 },
    { "factor": "查询扩展质量", "score": 1.0, "weight": 0.1 }
  ]
}
```

## 四、使用方法

### 4.1 在主页面使用

1. **输入查询**: 在输入框中输入问题
2. **点击"🧠"按钮**: 打开意图蒸馏面板
3. **点击"意图蒸馏"**: 开始分析
4. **查看结果**:
   - 识别的意图
   - 优化的查询建议
   - 置信度分析
   - 关键词和领域分布
5. **选择查询**: 点击任意优化查询的"使用"按钮
6. **发送**: 使用优化后的查询进行检索

### 4.2 API 调用

```typescript
// POST /api/intent-distillation
const response = await fetch('/api/intent-distillation', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    query: "如何优化数据库性能？",
    includeRewrite: true  // 是否包含查询改写
  })
});

const result = await response.json();
```

**返回结果**:
```json
{
  "success": true,
  "query": "如何优化数据库性能？",
  "timestamp": "2026-01-14T...",
  "domainAnalysis": { ... },
  "intentAnalysis": { ... },
  "queryRewrite": { ... },
  "confidence": { ... },
  "suggestions": [ ... ],
  "recommendedQuery": "数据库索引优化和查询性能提升的最佳实践"
}
```

### 4.3 在 RAG 系统中集成

```typescript
// 1. 先进行意图蒸馏
const distillation = await fetch('/api/intent-distillation', {
  method: 'POST',
  body: JSON.stringify({ query: userQuery })
}).then(r => r.json());

// 2. 使用优化后的查询进行检索
const optimizedQuery = distillation.recommendedQuery;

// 3. 可选：使用多个扩展查询进行并行检索
const allQueries = distillation.queryRewrite.rewritten;
const results = await Promise.all(
  allQueries.map(q => ragSystem.ask(q))
);

// 4. 合并和去重结果
const mergedResults = mergeAndDeduplicate(results);
```

## 五、最佳实践

### 5.1 何时使用意图蒸馏？

**推荐使用**:
- ✅ 模糊不清的查询
- ✅ 多义词查询
- ✅ 需要扩展的简短查询
- ✅ 跨领域的复杂查询
- ✅ 需要提高检索质量时

**不必使用**:
- ❌ 已经非常明确的查询
- ❌ 专业术语精准的查询
- ❌ 只包含关键词的查询

### 5.2 如何解读置信度？

| 置信度 | 说明 | 建议 |
|--------|------|------|
| ≥ 90% | 极高可信 | 直接使用推荐查询 |
| 80-90% | 高可信 | 使用推荐查询，可参考原查询 |
| 70-80% | 较可信 | 同时尝试原查询和优化查询 |
| 60-70% | 中等 | 谨慎使用，优先使用原查询 |
| < 60% | 低可信 | 重新表述查询或手动优化 |

### 5.3 优化建议的使用

**建议类型**:

1. **领域模糊**
   - 说明: 查询领域不够明确
   - 操作: 添加领域特定词汇
   - 示例: "性能优化" → "数据库性能优化"

2. **关键词不足**
   - 说明: 查询过于简短
   - 操作: 添加更多细节
   - 示例: "优化" → "如何优化数据库查询性能"

3. **意图模糊**
   - 说明: 查询目的不明确
   - 操作: 明确问题类型
   - 示例: "数据库" → "如何解决数据库性能问题"

4. **查询扩展**
   - 说明: 已生成扩展查询
   - 操作: 使用扩展查询获得更全面结果

### 5.4 查询改写的选择策略

**多个改写查询的使用**:

1. **顺序尝试**: 按推荐顺序依次尝试，直到获得满意结果
2. **并行检索**: 同时使用多个查询，合并结果
3. **A/B 对比**: 对比原查询和优化查询的结果质量
4. **智能选择**: 根据置信度自动选择最佳查询

## 六、系统配置

### 6.1 环境要求

```bash
# Ollama 服务
OLLAMA_BASE_URL=http://localhost:11434

# 必需模型
ollama pull llama3.1        # LLM 分析
ollama pull nomic-embed-text # 向量化
```

### 6.2 领域质心配置

确保已计算领域质心：
```bash
# 访问领域向量页面
http://localhost:3000/domain-vectors

# 点击"批量计算所有质心"
# 等待计算完成
```

### 6.3 性能优化

**缓存策略**:
- 缓存常见查询的意图分析结果
- 缓存领域分布计算结果
- 使用 Redis 或内存缓存

**并行处理**:
- 领域分析和 LLM 分析可以并行
- 多个扩展查询的检索可以并行

**超时控制**:
- LLM 分析超时: 30秒
- 向量化超时: 10秒
- 总体超时: 60秒

## 七、故障排查

### 7.1 意图分析失败

**症状**: "意图分析失败" 错误

**可能原因**:
1. Ollama 未启动
2. llama3.1 模型未安装
3. LLM 返回格式错误

**解决方案**:
```bash
# 检查 Ollama
curl http://localhost:11434/api/tags

# 安装模型
ollama pull llama3.1

# 查看日志
# 打开浏览器开发者工具 → Console
```

### 7.2 领域识别不准确

**症状**: 领域识别结果与预期不符

**可能原因**:
1. 领域质心未计算或过时
2. 种子词质量不佳
3. 查询过于通用

**解决方案**:
1. 重新计算领域质心
2. 优化种子词列表
3. 在查询中添加更多上下文

### 7.3 置信度过低

**症状**: 置信度 < 0.6

**可能原因**:
1. 查询过于模糊
2. 查询跨多个领域
3. 关键词太少

**解决方案**:
1. 重新表述查询，使其更明确
2. 添加领域限定词
3. 使用更详细的描述

## 八、技术细节

### 8.1 向量维度

- **Embedding 维度**: 768 维（nomic-embed-text）
- **质心向量**: 768 维归一化向量
- **查询向量**: 768 维归一化向量

### 8.2 相似度计算

```typescript
// 余弦相似度
cosineSimilarity(A, B) = (A · B) / (||A|| × ||B||)

// 归一化向量的余弦相似度简化为点积
cosineSimilarity(A_norm, B_norm) = A_norm · B_norm
```

### 8.3 LLM 参数

```typescript
{
  model: "llama3.1",
  temperature: 0.3,  // 低温度确保输出稳定
  num_predict: 1000  // 最大 token 数
}
```

## 九、扩展功能

### 9.1 多语言支持

- 当前: 中文优化
- 计划: 英文、日文支持
- 方法: 多语言领域质心 + 多语言 LLM

### 9.2 个性化意图

- 基于用户历史查询
- 学习用户偏好
- 自动调整领域权重

### 9.3 实时反馈学习

- 收集用户对优化查询的反馈
- 自动调整改写策略
- 持续优化置信度模型

---

**版本**: v1.0  
**最后更新**: 2026-01-14  
**相关文档**: 
- [领域向量指南](./DOMAIN_VECTORS_GUIDE.md)
- [RAG 系统文档](./README.md)
