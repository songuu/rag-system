# Self-RAG 系统完整指南

## 🎯 系统概述

**Self-RAG (Self-Reflective Retrieval-Augmented Generation)** 是一个具有自反思能力的 RAG 系统，通过四种反思令牌 (Reflection Tokens) 实现智能决策，自动优化检索和生成过程。

## 📊 系统架构

```
                              Self-RAG 流程图
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│   用户查询                                                          │
│      │                                                              │
│      ▼                                                              │
│   ┌─────────────────┐                                              │
│   │  Retrieve Token │  ──▶  判断是否需要检索                        │
│   │  🔍 YES / NO    │                                              │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼ (如果 YES)                                             │
│   ┌─────────────────┐                                              │
│   │  Document       │  ──▶  从知识库检索相关文档                    │
│   │  Retrieval      │                                              │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼                                                        │
│   ┌─────────────────┐                                              │
│   │  IsRel Token    │  ──▶  评估每个文档的相关性                    │
│   │  ✅ RELEVANT    │                                              │
│   │  ❌ NOT_RELEVANT│                                              │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼                                                        │
│   ┌─────────────────┐                                              │
│   │  Response       │  ──▶  基于相关文档生成回答                    │
│   │  Generation     │                                              │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼                                                        │
│   ┌─────────────────┐                                              │
│   │  IsSup Token    │  ──▶  评估回答是否被文档支持                  │
│   │  📚 SUPPORTED   │                                              │
│   │  ⚠️ NOT_SUPPORTED│                                             │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼                                                        │
│   ┌─────────────────┐                                              │
│   │  IsUse Token    │  ──▶  评估回答的有用性                        │
│   │  👍 USEFUL      │                                              │
│   │  👎 NOT_USEFUL  │                                              │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼ (如果支持度或有用性不足)                                │
│   ┌─────────────────┐                                              │
│   │  Regeneration   │  ──▶  迭代优化回答                            │
│   │  Loop (max 2)   │                                              │
│   └────────┬────────┘                                              │
│            │                                                        │
│            ▼                                                        │
│   ┌─────────────────┐                                              │
│   │  Final Response │  ──▶  输出最终回答                            │
│   └─────────────────┘                                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

## 🔑 四种反思令牌详解

### 1. Retrieve Token (检索决策令牌)

**作用**: 判断是否需要从知识库检索信息

| 值 | 说明 | 触发条件 |
|---|---|---|
| **YES** 🔍 | 需要检索 | 事实性问题、专业领域问题、需要具体信息 |
| **NO** ⏭️ | 不需要检索 | 简单计算、打招呼、常识问题 |

**示例**:
```
查询: "什么是机器学习？"  → YES (需要专业知识)
查询: "1+1等于多少？"     → NO (简单计算)
查询: "你好"             → NO (打招呼)
```

### 2. IsRel Token (相关性评估令牌)

**作用**: 评估每个检索文档与查询的相关程度

| 值 | 说明 | 分数范围 |
|---|---|---|
| **RELEVANT** ✅ | 文档相关 | score > 0.5 |
| **NOT_RELEVANT** ❌ | 文档不相关 | score ≤ 0.5 |

**评估维度**:
- 主题相关性: 文档是否讨论查询涉及的主题
- 信息覆盖度: 文档是否包含回答所需信息
- 语义匹配度: 文档与查询的语义相似程度

### 3. IsSup Token (支持度评估令牌)

**作用**: 评估生成的回答是否被检索文档支持

| 值 | 说明 | 分数范围 |
|---|---|---|
| **SUPPORTED** 📚 | 回答有文档支持 | score ≥ 0.6 |
| **NOT_SUPPORTED** ⚠️ | 回答缺乏支持 | score < 0.6 |

**评估方法**:
1. 将回答分解为多个陈述
2. 检查每个陈述是否有文档证据
3. 计算整体支持度得分

### 4. IsUse Token (有用性评估令牌)

**作用**: 评估回答对用户查询的实际有用程度

| 值 | 说明 | 分数范围 |
|---|---|---|
| **USEFUL** 👍 | 回答有用 | score ≥ 0.6 |
| **NOT_USEFUL** 👎 | 回答无用 | score < 0.6 |

**评估维度**:
- 完整性: 是否全面回答了问题
- 准确性: 信息是否准确
- 清晰度: 表达是否清晰
- 实用性: 是否提供可操作信息
- 相关性: 是否紧扣问题

## 🎨 可视化界面

### 页面入口

主页导航栏 → 点击 **「Self-RAG」** 按钮 → 进入可视化页面

### 界面布局

```
┌─────────────────────────────────────────────────────────────────┐
│ 🔄 Self-RAG                                     [导航链接...]   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  💬 输入查询                                                    │
│  ┌─────────────────────────────────────┐ ┌────────────────┐    │
│  │ 输入您的问题...                      │ │ 🚀 运行 Self-RAG│    │
│  └─────────────────────────────────────┘ └────────────────┘    │
│  快速测试: [示例1] [示例2] [示例3] [示例4] [示例5]              │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  🎯 反思令牌 (Reflection Tokens)                               │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐  │
│  │ 🔍 Retrieve │ │ 📋 IsRel   │ │ 📚 IsSup   │ │ 👍 IsUse   │  │
│  │    YES      │ │   3/5      │ │  72.5%     │ │  85.0%     │  │
│  │   85.0%     │ │   65.0%    │ │ SUPPORTED  │ │  USEFUL    │  │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘  │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 处理流程可视化                        总耗时: 5.23s         │
│                                                                 │
│  ①──────▶②──────▶③──────▶④──────▶⑤                           │
│  Retrieve  Retrieval  Generation  IsSup    IsUse               │
│  Decision            Response    Check    Check                │
│                                                                 │
│  [点击步骤查看详情...]                                          │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📄 检索文档 & 相关性评估                                       │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ✅ sample.txt      相似度: 85.3%  相关性: 78.5%         │   │
│  │    ████████████████████░░░░░░░░░░ RELEVANT              │   │
│  └─────────────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ❌ sample2.txt     相似度: 45.2%  相关性: 32.1%         │   │
│  │    ████████░░░░░░░░░░░░░░░░░░░░░░ NOT RELEVANT          │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 支持度分析 (IsSup)                    整体支持度: 72.5%    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ ✓ "机器学习是一种人工智能技术"       支持度: 95.0%      │   │
│  │ ✓ "它通过数据训练模型"               支持度: 88.0%      │   │
│  │ ? "广泛应用于各个领域"               支持度: 45.0%      │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  💡 最终回答                                                    │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ 机器学习是人工智能的一个分支，它使计算机能够从数据中     │   │
│  │ 学习并做出预测或决策，而无需明确编程...                  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ⏱️ 反思令牌时间线                                              │
│  │                                                             │
│  ├─ 🔍 RETRIEVE: YES (85.0%) - 需要检索专业知识                │
│  │     └─ 120ms                                                │
│  ├─ ✅ ISREL: RELEVANT (78.5%) - 文档1相关                     │
│  │     └─ 450ms                                                │
│  ├─ ❌ ISREL: NOT_RELEVANT (32.1%) - 文档2不相关               │
│  │     └─ 380ms                                                │
│  ├─ 📚 ISSUP: SUPPORTED (72.5%) - 回答被文档支持               │
│  │     └─ 680ms                                                │
│  └─ 👍 ISUSE: USEFUL (85.0%) - 回答有用                        │
│        └─ 520ms                                                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 📡 API 接口

### POST /api/self-rag

执行 Self-RAG 查询

**请求**:
```json
{
  "query": "什么是机器学习？",
  "options": {
    "topK": 5,
    "similarityThreshold": 0.3,
    "maxIterations": 2,
    "supportThreshold": 0.6,
    "usefulnessThreshold": 0.6
  }
}
```

**响应**:
```json
{
  "success": true,
  "query": "什么是机器学习？",
  "finalResponse": "机器学习是...",
  "steps": [
    {
      "stepId": 1,
      "stepName": "Retrieve Decision",
      "input": { "query": "..." },
      "output": { "needRetrieval": true },
      "reflection": {
        "type": "retrieve",
        "value": "YES",
        "score": 0.85,
        "reasoning": "需要检索专业知识"
      },
      "duration": 120,
      "status": "completed"
    }
    // ... 更多步骤
  ],
  "reflectionTokens": [
    { "type": "retrieve", "value": "YES", "score": 0.85, "reasoning": "...", "timestamp": 120 }
    // ... 更多令牌
  ],
  "documents": [
    {
      "content": "...",
      "source": "sample.txt",
      "similarity": 0.853,
      "isRelevant": true,
      "relevanceScore": 0.785,
      "relevanceReasoning": "..."
    }
  ],
  "supportAnalysis": {
    "segments": [
      {
        "text": "机器学习是一种人工智能技术",
        "isSupported": true,
        "supportScore": 0.95,
        "supportingDocs": ["Doc1"],
        "reasoning": "..."
      }
    ],
    "overallSupport": 0.725
  },
  "iterations": 0,
  "totalTime": 5230,
  "metrics": {
    "retrieveDecision": { ... },
    "relevanceScores": [0.785, 0.321],
    "supportScore": 0.725,
    "usefulnessScore": 0.85
  }
}
```

### GET /api/self-rag

获取系统信息

**响应**:
```json
{
  "success": true,
  "systemInfo": {
    "name": "Self-RAG System",
    "version": "1.0.0",
    "description": "...",
    "llmModel": "llama3.1",
    "embeddingModel": "nomic-embed-text",
    "documentCount": 27,
    "embeddingDimension": 768
  },
  "reflectionTokens": [
    { "name": "Retrieve", "description": "判断是否需要检索" },
    { "name": "IsRel", "description": "评估文档相关性" },
    { "name": "IsSup", "description": "评估回答支持度" },
    { "name": "IsUse", "description": "评估回答有用性" }
  ],
  "defaultOptions": { ... }
}
```

## ⚙️ 配置参数

| 参数 | 默认值 | 说明 |
|-----|-------|------|
| `topK` | 5 | 检索文档数量 |
| `similarityThreshold` | 0.3 | 相似度阈值 |
| `maxIterations` | 2 | 最大迭代次数 |
| `supportThreshold` | 0.6 | 支持度阈值 |
| `usefulnessThreshold` | 0.6 | 有用性阈值 |

## 🔄 迭代优化机制

当支持度或有用性低于阈值时，系统会自动进行迭代优化：

```
第1次生成
    │
    ├─ IsSup: 52% < 60% ✗
    │
    ▼
反馈优化 → 重新生成
    │
    ├─ IsSup: 68% ≥ 60% ✓
    ├─ IsUse: 75% ≥ 60% ✓
    │
    ▼
输出最终回答
```

**迭代反馈示例**:
```
支持度: 52.0%, 有用性: 45.0%。请提供更准确、更有帮助的回答。
```

## 📈 性能指标

### 处理时间分布

| 步骤 | 典型耗时 | 说明 |
|------|---------|------|
| Retrieve Decision | 100-200ms | LLM 判断 |
| Document Retrieval | 50-150ms | 向量检索 |
| IsRel Evaluation | 300-500ms/doc | 每文档评估 |
| Response Generation | 500-1500ms | LLM 生成 |
| IsSup Evaluation | 500-800ms | 支持度检查 |
| IsUse Evaluation | 400-600ms | 有用性检查 |

### 总体性能

- **平均处理时间**: 3-8秒
- **迭代情况**: ~30% 查询需要迭代
- **成功率**: >95%

## 🔍 与传统 RAG 的对比

| 特性 | 传统 RAG | Self-RAG |
|------|---------|----------|
| 检索决策 | 总是检索 | 智能判断 |
| 文档筛选 | 仅按相似度 | 相关性评估 |
| 回答验证 | 无 | 支持度检查 |
| 质量评估 | 无 | 有用性评估 |
| 自动优化 | 无 | 迭代改进 |
| 可解释性 | 低 | 高 (反思令牌) |

## 💡 使用场景

### 适合使用 Self-RAG

1. **高质量要求**: 需要准确、可靠的回答
2. **知识问答**: 基于文档库的问答系统
3. **专业领域**: 医疗、法律、金融等需要高准确性的领域
4. **可解释性需求**: 需要了解回答来源和依据

### 不推荐使用

1. **实时对话**: 对延迟敏感的场景
2. **创意生成**: 不需要事实支持的创意任务
3. **简单查询**: 可以直接回答的简单问题

## 🛠️ 故障排查

### 问题 1: Retrieve 总是返回 YES

**原因**: LLM 判断过于保守  
**解决**: 调整 prompt 或降低温度参数

### 问题 2: 相关性评估不准确

**原因**: 文档质量或向量模型问题  
**解决**: 
1. 检查文档内容质量
2. 确保 embedding 模型正确加载
3. 调整相似度阈值

### 问题 3: 支持度评估过低

**原因**: 回答包含文档未覆盖的信息  
**解决**: 
1. 检查检索到的文档是否包含相关信息
2. 调整 topK 增加检索文档数量

### 问题 4: 迭代次数过多

**原因**: 阈值设置过高  
**解决**: 
1. 降低 `supportThreshold`
2. 降低 `usefulnessThreshold`
3. 减少 `maxIterations`

## 📚 参考资料

- **Self-RAG Paper**: [Self-Reflective Retrieval-Augmented Generation](https://arxiv.org/abs/2310.11511)
- **RAG Best Practices**: [LangChain RAG Guide](https://python.langchain.com/docs/use_cases/question_answering/)
- **Ollama Documentation**: [Ollama API](https://ollama.ai/docs/api)

## 🔮 未来增强

### 计划功能

1. **批量处理**: 支持批量查询
2. **缓存机制**: 缓存常见查询结果
3. **自定义令牌**: 支持添加自定义反思令牌
4. **A/B 测试**: 对比不同配置的效果
5. **历史记录**: 保存和分析历史查询

### 研究方向

- 🔬 更精细的支持度评估
- 🔬 多轮对话中的 Self-RAG
- 🔬 基于用户反馈的在线学习
- 🔬 多模态 Self-RAG

---

**版本**: v1.0  
**最后更新**: 2026-01-15  
**状态**: ✅ 生产就绪  
**维护者**: RAG System Team
